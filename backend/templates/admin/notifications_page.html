{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %}

{% block nav-sidebar %}{{ block.super }}{% endblock %}
{% block breadcrumbs %}{% endblock %}

{% block content %}
<style>
  td,th{ color: rgba(36, 51, 108, 0.67); }

  .noti-actions .button,
  .row-actions .button {
    display:inline-block; min-width:30px; text-align:center;
    padding:4px 8px; font-size:13px; line-height:1.4;
    border-radius:4px; color:#fff !important; border:none; cursor:pointer;
    background:#1e73be;
  }
  .noti-actions .button:hover,
  .row-actions .button:hover { background:#1a5bb8; }

  .noti-toolbar { display:flex; align-items:center; gap:12px; margin-bottom:10px; }

  .noti-tabs a {
    display:inline-block; padding:6px 10px; border-radius:6px; text-decoration:none;
    border:1px solid #c3c4c7; background:#f6f7f7; color:#2c3338; font-weight:600;
  }
  .noti-tabs a.active { background:#1a5bb8; color:#fff; border-color:black; }

  .noti-badge {
    display:inline-block; min-width:18px; padding:0 6px; line-height:18px;
    font-size:11px; background:#d9534f; color:#fff; border-radius:9px; margin-left:6px;
  }

  .noti-table th, .noti-table td { vertical-align:middle; }

  .pill {
    display:inline-block; padding:2px 8px; border-radius:999px;
    font-size:12px; border:1px solid #c3c4c7; background:#f1f5f9; color:#111;
  }
  .pill.unread { background:#ffe9e6; border-color:#ffcabf; }
  .pill.contact { background:#e7f3ff; border-color:#b6dbff; }
  .pill.job { background:#eaf7ea; border-color:#b6e2b6; }

  tr.unread { background:#fffdf8; font-weight:600; }
  tr.read { opacity:.75; }

  .sel-col { width:36px; text-align:center; }
  .sel-col input[type="checkbox"] { transform:scale(1.15); cursor:pointer; }
</style>

<h1>Notifications</h1>

<div class="noti-toolbar">
  <div class="noti-tabs">
  {% with current_type=request.GET.type %}
    <a href="{% url 'admin-notifications' %}?type=job&status=unread"
       class="{% if current_type == 'job' %}active{% endif %}">
      Job Unread
      {% if unread_count > 0 %}
        <span class="noti-badge">{{ unread_count }}</span>
      {% endif %}
    </a>

    <a href="{% url 'admin-notifications' %}?type=contact&status=unread"
       class="{% if current_type == 'contact' %}active{% endif %}">
      Contact Unread
      {% if contact_unread_count > 0 %}
        <span class="noti-badge">{{ contact_unread_count }}</span>
      {% endif %}
    </a>

    <a href="{% url 'admin-notifications' %}?status=all"
       class="{% if status_filter == 'all' %}active{% endif %}">
      All
    </a>
  {% endwith %}
</div>

  <div style="flex:1"></div>

  <div class="noti-actions">
    <form method="post" action="{% url 'admin-notifications-mark-all' %}">
      {% csrf_token %}
      <input type="hidden" name="status" value="{{ status_filter }}">
      <button type="submit" class="button">Mark all as read</button>
    </form>
  </div>
</div>

<form method="post" action="" id="bulk-form" style="margin:8px 0 12px; display:flex; gap:8px;">
  {% csrf_token %}
  <input type="hidden" name="status" value="{{ status_filter }}">
  <select name="action" id="bulk-action">
    <option value="bulk_delete">Remove selected</option>
  </select>
  <button type="submit" class="button" id="bulk-go">Go</button>
</form>

<div class="module">
  <table class="adminlist noti-table">
    <thead>
      <tr>
        <th class="sel-col"><input type="checkbox" id="select-all"></th>
        <th>User</th>
        <th>Message</th>
        <th>Type</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for n in page_obj.object_list %}
      <tr class="{% if n.is_read %}read{% else %}unread{% endif %}">
        <td class="sel-col">
          <input type="checkbox" name="ids" value="{{ n.id }}" class="row-check" form="bulk-form">
        </td>
        <td>{{ n.user.email }}</td>
        <td>{{ n.message|truncatechars:80 }}</td>
        <td>
          <span class="pill {{ n.type }} {% if not n.is_read %}unread{% endif %}">
            {{ n.type|capfirst }}
          </span>
        </td>
        <td>{{ n.created_at|date:"M d, Y · h:i A" }}</td>
        <td class="row-actions">
          <a href="{% url 'admin-notification-detail' n.id %}?status={{ status_filter }}&page={{ page_obj.number }}"
             class="button">Detail</a>

          {% if not n.is_read %}
          <form method="post" action="{% url 'admin-notifications-mark-read' n.id %}" style="display:inline">
            {% csrf_token %}
            <button class="button" type="submit">Mark read</button>
          </form>
          {% else %}
            <span style="color:#4caf50; font-weight:600">Read</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6">No notifications.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% with current_type=request.GET.type %}
<div class="paginator">
  {% if page_obj.has_previous %}
    <a href="?{% if current_type %}type={{ current_type }}&{% endif %}status={{ status_filter }}&page={{ page_obj.previous_page_number }}">
      « Previous
    </a>
  {% else %}
    <span class="disabled">« Previous</span>
  {% endif %}

  <span class="current">
    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
  </span>

  {% if page_obj.has_next %}
    <a href="?{% if current_type %}type={{ current_type }}&{% endif %}status={{ status_filter }}&page={{ page_obj.next_page_number }}">
      Next »
    </a>
  {% else %}
    <span class="disabled">Next »</span>
  {% endif %}
</div>
{% endwith %}


<script>
  const selectAll = document.getElementById('select-all');
  const rowChecks = () => document.querySelectorAll('input.row-check[form="bulk-form"]');

  if (selectAll) {
    selectAll.addEventListener('change', e => {
      rowChecks().forEach(c => c.checked = e.target.checked);
    });
  }

  const bulkForm = document.getElementById("bulk-form");
  bulkForm.addEventListener("submit", function(e) {
    if (!e.submitter || e.submitter.id !== "bulk-go") return;
    const checked = document.querySelector('input.row-check[form="bulk-form"]:checked');
    if (!checked) {
      alert("Please select at least one notification.");
      e.preventDefault();
    }
  });
</script>

{% endblock %}
